#The following code extract's twitter data using Streaming API provided by Twitter.
from tweepy import Stream
from tweepy import OAuthHandler
from tweepy.streaming import StreamListener
import csv
import time
import json
from unicodewriter import UnicodeWriter

#consumer key, consumer secret, access token, access secret to be generated by creating an app on https://apps.twitter.com/
ckey= "XXXXXXXXXXXXXXXXXXX"
csecret= "XXXXXXXXXXXXXXXXXXX"
atoken= "XXXXXXXXXXXXXXXXXXX"
asecret= "XXXXXXXXXXXXXXXXXXX"

savefile = open('twitter_data.csv','wb')
#x = csv.writer(savefile)
x = UnicodeWriter(savefile)

x.writerow(["tweet_coordinates","tweet_created_at","tweet_favorite_count","tweet_id","tweet_lang","tweet_place_country","tweet_place_city","tweet_retweet_count","tweet_text","tweet_truncated","tweet_user_favourites_count","tweet_user_followers_count","tweet_user_friends_count","tweet_user_id","tweet_user_listed_count","tweet_user_location","tweet_user_name","tweet_user_profile_image_url","tweet_user_profile_image_url_https","tweet_user_screen_name","tweet_user_statuses_count","tweet_user_time_zone","tweet_user_verified","retweet_coordinates","retweet_created_at","retweet_favorite_count","retweet_id","retweet_lang","retweet_place_country","retweet_place_city","retweet_retweet_count","retweet_text","retweet_truncated","retweet_user_favourites_count","retweet_user_followers_count","retweet_user_friends_count","retweet_user_id","retweet_user_listed_count","retweet_user_location","retweet_user_name","retweet_user_profile_image_url","retweet_user_profile_image_url_https","retweet_user_screen_name","retweet_user_statuses_count","retweet_user_time_zone","retweet_user_verified"])

def fields(data):
    tweet_coordinates = ''
    if data.get('coordinates'):
        if data['coordinates'].get('coordinates',''):
            tweet_coordinates = data['coordinates'].get('coordinates','')
    tweet_created_at = data.get('created_at','')
    tweet_favorite_count = data.get('favorite_count','')
    tweet_id = data.get('id_str','')
    tweet_lang = data.get('lang','')
    tweet_place_country = ''
    tweet_place_city = ''
    if data.get('place'):
        tweet_place_country = data['place'].get('country_code','')
        tweet_place_city = data['place'].get('name','')
    tweet_retweet_count = data.get('retweet_count','')
    tweet_text = data.get('text','')
    tweet_truncated = data.get('truncated','')
    tweet_user_favourites_count = ''
    tweet_user_followers_count = ''
    tweet_user_friends_count = ''
    tweet_user_id = ''
    tweet_user_listed_count = ''
    tweet_user_location = ''
    tweet_user_name = ''
    tweet_user_profile_image_url = ''
    tweet_user_profile_image_url_https = ''
    tweet_user_screen_name = ''
    tweet_user_statuses_count = ''
    tweet_user_time_zone = ''
    tweet_user_verified = ''
    if data.get('user'):
        tweet_user_favourites_count = data['user'].get('favourites_count','')
        tweet_user_followers_count = data['user'].get('followers_count','')
        tweet_user_friends_count = data['user'].get('friends_count','')
        tweet_user_id = str(data['user'].get('id_str',''))
        tweet_user_listed_count = data['user'].get('listed_count','')
        tweet_user_location = str(data['user'].get('location',''))
        tweet_user_name = str(data['user'].get('name',''))
        tweet_user_profile_image_url = str(data['user'].get('profile_image_url',''))
        tweet_user_profile_image_url_https = str(data['user'].get('profile_image_url_https',''))
        tweet_user_screen_name =  str(data['user']['screen_name'])
        tweet_user_statuses_count = data['user'].get('statuses_count','')
        tweet_user_time_zone = str(data['user'].get('time_zone',''))
        tweet_user_verified = data['user'].get('verified','')
    #print("1 row done")
    abc = [tweet_coordinates,tweet_created_at,tweet_favorite_count,tweet_id,tweet_lang,tweet_place_country,tweet_place_city,tweet_retweet_count,tweet_text,tweet_truncated,tweet_user_favourites_count,tweet_user_followers_count,tweet_user_friends_count,tweet_user_id,tweet_user_listed_count,tweet_user_location,tweet_user_name,tweet_user_profile_image_url,tweet_user_profile_image_url_https,tweet_user_screen_name,tweet_user_statuses_count,tweet_user_time_zone,tweet_user_verified]
    # list_ret = []
    # if fname == '':
    #     for i in abc:
    #         list_ret.append(globals()[i])
    # else:
    #     for i in abc:
    #         globals()[fname + i] = globals()[i]
    #         list_ret.append(globals()[fname + i])
    return(abc)

class listener(StreamListener):
    def on_data(self, data):
        try:
            data = json.loads(data)
            output = []
            if data.get('retweeted_status'):
                #print data.items()
                tweet_output = fields(data['retweeted_status'])
                retweet_output = fields(data)
            else:
                #print data.items()
                tweet_output = fields(data)
                retweet_output = ['' for i in range(len(tweet_output))]
            output.extend(tweet_output)
            output.extend(retweet_output)
            print output
            for i in range(len(output)):
                if type(output[i]) == str:
                    output[i] = output[i].encode('utf-8','ignore')
            x.writerow(output)
            return(True)
        except BaseException, e:
            print 'failed on data,',str(e)
            time.sleep(59)
    def on_error(self, status):
        print status

auth = OAuthHandler(ckey, csecret)
auth.set_access_token(atoken, asecret)

twitterStream = Stream(auth, listener())
twitterStream.filter(track=["PV Sindhu"])       #, "Cofee", "sadjlfksd"])
#twitterStream.filter(language=["en"])

savefile.close()
